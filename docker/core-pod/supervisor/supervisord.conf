# DreamScape Core Pod Supervisor Configuration
# DR-336: INFRA-010.3 - Configuration Supervisor et Orchestration
# Manages NGINX, Auth Service, and User Service in a single container

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info
silent=false
minfds=1024
minprocs=200

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
username=admin
password=dreamscape_supervisor_123

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
username=admin
password=dreamscape_supervisor_123

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Auth Service Program - Priority 10 (starts first)
[program:auth-service]
command=node -r tsconfig-paths/register dist/server.js
directory=/app/auth
user=nodejs
autostart=true
autorestart=true
priority=10
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/auth-service.log
stderr_logfile=/var/log/supervisor/auth-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV="%(ENV_NODE_ENV)s",PORT=3001,SERVICE_NAME="auth-service",DATABASE_URL="%(ENV_DATABASE_URL)s",REDIS_URL="%(ENV_REDIS_URL)s",JWT_SECRET="%(ENV_JWT_SECRET)s",JWT_REFRESH_SECRET="%(ENV_JWT_REFRESH_SECRET)s"

# User Service Program - Priority 20 (starts second)
[program:user-service]
command=node -r tsconfig-paths/register dist/server.js
directory=/app/user
user=nodejs
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/user-service.log
stderr_logfile=/var/log/supervisor/user-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV="%(ENV_NODE_ENV)s",PORT=3002,SERVICE_NAME="user-service",DATABASE_URL="%(ENV_DATABASE_URL)s",REDIS_URL="%(ENV_REDIS_URL)s",JWT_SECRET="%(ENV_JWT_SECRET)s",UPLOAD_DIR="/app/user/uploads"

# NGINX Program - Priority 30 (starts after services)
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
priority=30
startsecs=5
startretries=3
stopwaitsecs=10
stopsignal=SIGQUIT
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
user=nginx

# Process monitoring group for coordinated restarts
[group:core-services]
programs=auth-service,user-service
priority=100

[group:infrastructure]
programs=nginx
priority=200
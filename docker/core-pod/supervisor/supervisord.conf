# DreamScape Core Pod Supervisor Configuration
# DR-336: INFRA-010.3 - Configuration Supervisor et Orchestration
# Manages NGINX, Auth Service, and User Service in a single container

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info
silent=false
minfds=1024
minprocs=200

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
username=admin
password=dreamscape_supervisor_123

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
username=admin
password=dreamscape_supervisor_123

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Auth Service Program - Priority 10 (starts first)
[program:auth-service]
command=node dist/server.js
directory=/app/auth
user=nodejs
autostart=true
autorestart=true
priority=10
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/auth-service.log
stderr_logfile=/var/log/supervisor/auth-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV=production,PORT=3001,SERVICE_NAME="auth-service"

# User Service Program - Priority 20 (starts second)
[program:user-service]
command=node dist/server.js
directory=/app/user
user=nodejs
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/user-service.log
stderr_logfile=/var/log/supervisor/user-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV=production,PORT=3002,SERVICE_NAME="user-service"

# NGINX Program - Priority 30 (starts after services)
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
priority=30
startsecs=5
startretries=3
stopwaitsecs=10
stopsignal=SIGQUIT
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
user=nginx

# Health Check Service - Priority 40 (starts last)
[program:health-checker]
command=python3 /app/scripts/health_monitor.py
autostart=true
autorestart=true
priority=40
startsecs=5
startretries=3
stopwaitsecs=5
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/health-checker.log
stderr_logfile=/var/log/supervisor/health-checker-error.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
user=nodejs

# Process monitoring group for coordinated restarts
[group:core-services]
programs=auth-service,user-service
priority=100

[group:infrastructure]
programs=nginx,health-checker
priority=200

# Event listeners for monitoring and alerting
[eventlistener:crashmail]
command=/app/scripts/crash_notifier.py
events=PROCESS_STATE_FATAL,PROCESS_STATE_EXITED
buffer_size=100
stdout_logfile=/var/log/supervisor/crashmail.log
stderr_logfile=/var/log/supervisor/crashmail-error.log

# Memory monitor for preventing OOM
[eventlistener:memmon]
command=/app/scripts/memory_monitor.py
events=TICK_60
buffer_size=100
stdout_logfile=/var/log/supervisor/memmon.log
stderr_logfile=/var/log/supervisor/memmon-error.log
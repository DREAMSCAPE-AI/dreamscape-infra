# VR Content Streaming Optimization - DR-328
# Advanced configuration for panoramic content delivery
# Experience Pod - Big Pods Architecture
# Optimized for performance: Progressive loading, adaptive quality

# VR content streaming server block
server {
    listen 80;
    server_name vr.dreamscape.local;
    
    root /usr/share/nginx/html/vr;
    
    # VR-specific performance optimizations
    client_max_body_size 500M;  # Large VR file uploads
    client_body_timeout 300s;
    client_header_timeout 60s;
    
    # ========================================
    # Adaptive VR Content Delivery
    # ========================================
    
    # High-quality VR content (4K+) - DR-328 optimized
    location /hq/ {
        # Intelligent bandwidth throttling for high-quality content
        limit_rate_after 5m;    # Reduced for faster initial load
        limit_rate 3m;          # Increased for better streaming
        
        # Extended cache for processed VR content
        expires 90d;
        add_header Cache-Control "public, max-age=7776000, immutable";
        add_header X-VR-Quality "high";
        add_header X-VR-Optimized "DR-328";
        
        # Essential for progressive streaming
        add_header Accept-Ranges bytes;
        
        # Performance hints for VR content
        add_header Link '</vr/preload.js>; rel=preload; as=script, </vr/webxr-polyfill.js>; rel=preload; as=script';
        
        # Enable compression for better performance
        gzip_static on;
    }
    
    # Medium quality VR content (2K)
    location /mq/ {
        limit_rate_after 5m;
        limit_rate 1m;
        
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-VR-Quality "medium";
        add_header Accept-Ranges bytes;
    }
    
    # Low quality/preview VR content (1K)
    location /lq/ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        add_header X-VR-Quality "low";
        add_header Accept-Ranges bytes;
    }
    
    # ========================================
    # VR Content Format Optimization
    # ========================================
    
    # WebP VR content (modern browsers)
    location ~* \.webp$ {
        expires 90d;
        add_header Vary "Accept";
        add_header X-VR-Format "webp";
        
        # Fallback to JPEG if WebP not supported
        try_files $uri @jpeg_fallback;
    }
    
    # AVIF VR content (cutting-edge browsers)
    location ~* \.avif$ {
        expires 90d;
        add_header Vary "Accept";
        add_header X-VR-Format "avif";
        
        # Fallback chain: AVIF -> WebP -> JPEG
        try_files $uri @webp_fallback;
    }
    
    # ========================================
    # Progressive Loading Support
    # ========================================
    
    # VR thumbnails for quick preview
    location /thumbs/ {
        expires 24h;
        add_header Cache-Control "public, max-age=86400";
        add_header X-VR-Type "thumbnail";
        
        # Aggressive compression for thumbnails
        gzip on;
        gzip_types image/jpeg image/png;
    }
    
    # VR metadata and manifests
    location ~* \.(json|xml|manifest)$ {
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
        add_header Content-Type application/json;
        
        # CORS for VR metadata
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
    }
    
    # ========================================
    # VR Streaming Analytics
    # ========================================
    
    # Custom log format for VR analytics
    log_format vr_analytics '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'vr_quality="$arg_quality" '
                           'vr_format="$arg_format" '
                           'range="$http_range" '
                           'request_time=$request_time '
                           'upstream_time=$upstream_response_time';
    
    access_log /var/log/nginx/vr-analytics.log vr_analytics;
    
    # ========================================
    # Error Handling and Fallbacks
    # ========================================
    
    # JPEG fallback for WebP
    location @jpeg_fallback {
        rewrite ^(.+)\.webp$ $1.jpg last;
    }
    
    # WebP fallback for AVIF
    location @webp_fallback {
        rewrite ^(.+)\.avif$ $1.webp last;
    }
    
    # Generic VR content fallback
    location @vr_fallback {
        return 404 '{"error": "VR content not found", "formats": ["webp", "avif", "jpg"]}';
        add_header Content-Type application/json;
    }
    
    # ========================================
    # VR Content Security
    # ========================================
    
    # Hotlink protection for VR content
    location ~* \.(webp|avif|jpg|jpeg|png)$ {
        valid_referers none blocked server_names
                       *.dreamscape.com dreamscape.com
                       localhost 127.0.0.1;
                       
        if ($invalid_referer) {
            return 403 "VR content access denied";
        }
        
        # Standard VR content headers
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
    }
    
    # Rate limiting for VR content access
    limit_req zone=vr burst=3 nodelay;
    
    # ========================================
    # Performance Monitoring
    # ========================================
    
    # VR performance metrics endpoint
    location /vr-metrics {
        access_log off;
        
        # Return VR-specific metrics
        return 200 '{"vr_cache_hit_ratio": "$upstream_cache_status", "avg_response_time": "$request_time"}';
        add_header Content-Type application/json;
        
        # Restrict access to monitoring systems
        allow 127.0.0.1;
        deny all;
    }
}
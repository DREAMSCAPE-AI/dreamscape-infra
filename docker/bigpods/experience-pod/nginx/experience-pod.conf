# Experience Pod Virtual Host Configuration
# DreamScape Big Pods Architecture - Frontend + VR + Gateway

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Security and performance headers for Experience Pod DR-328
    add_header X-Experience-Pod "DreamScape-v1.2" always;
    add_header X-Pod-Architecture "big-pods" always;
    
    # Default cache control (overridden by specific locations)
    add_header Cache-Control "public, max-age=3600" always;

    # ========================================
    # Static Assets - Web Client
    # ========================================
    
    # Root path serves React application
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache static assets aggressively for performance (DR-328 target: <2s FCL)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
            
            # Enable pre-compressed assets
            gzip_static on;
            
            # Modern image format support with fallback
            location ~* \.(webp|avif)$ {
                add_header Vary "Accept";
                expires 1y;
            }
            
            # Performance optimization for assets
            tcp_nodelay off;
            tcp_nopush on;
        }
        
        # HTML files - short cache for updates
        location ~* \.html$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }
        
        # Service Worker - no cache
        location = /sw.js {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # ========================================
    # VR Content Streaming
    # ========================================
    
    # VR panoramas and 360° content
    location /vr/ {
        alias /usr/share/nginx/html/vr/;
        
        # Apply rate limiting for large VR files
        limit_req zone=vr burst=5 nodelay;
        
        # Optimized for large files
        sendfile on;
        tcp_nopush on;
        tcp_nodelay off;
        
        # Long cache for VR content
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        
        # VR-specific headers
        add_header X-VR-Content "true";
        add_header X-Content-Disposition "inline";
        
        # Support for Range requests (streaming)
        add_header Accept-Ranges bytes;
        
        # VR file types optimization
        location ~* \.(webp|avif)$ {
            expires 90d;
            add_header Vary "Accept";
        }
        
        # Fallback for older browsers
        location ~* \.(jpg|jpeg|png)$ {
            expires 30d;
        }
    }

    # ========================================
    # API Proxy - Gateway Service
    # ========================================
    
    # Gateway API proxy
    location /api/gateway/ {
        # Remove /api/gateway prefix
        rewrite ^/api/gateway/(.*) /$1 break;
        
        # Proxy to internal gateway service
        proxy_pass http://gateway_service;
        
        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeout settings
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 30s;
        
        # Rate limiting
        limit_req zone=api burst=10 nodelay;
        
        # No caching for API responses
        proxy_cache off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Generic API routes — proxied to gateway (handles /api/v1/*, /api/auth, etc.)
    # Placé après /api/gateway/ mais avant /api/panorama/ : NGINX fait longest-prefix-match
    # donc /api/panorama/ et /api/gateway/ gardent la priorité
    location /api/ {
        proxy_pass http://gateway_service;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 30s;

        limit_req zone=api burst=10 nodelay;

        proxy_cache off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ========================================
    # Panorama Service API
    # ========================================
    
    # Panorama service endpoints
    location /api/panorama/ {
        # Remove /api/panorama prefix
        rewrite ^/api/panorama/(.*) /$1 break;
        
        # Proxy to panorama service
        proxy_pass http://panorama_service;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeout for VR processing
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;
        
        # Rate limiting for VR API
        limit_req zone=vr burst=3 nodelay;
        
        # Cache VR metadata
        proxy_cache vr_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_key "$request_uri";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # ========================================
    # WebSocket Support
    # ========================================
    
    # WebSocket connections for real-time features
    location /ws/ {
        proxy_pass http://gateway_service;
        
        # WebSocket specific headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket timeout
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ========================================
    # Health Checks and Monitoring
    # ========================================
    
    # Experience Pod health check
    location /health {
        access_log off;
        return 200 "Experience Pod NGINX - OK\n";
        add_header Content-Type text/plain;
    }
    
    # NGINX status for monitoring
    location /nginx-status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
    
    # Gateway service health check
    location /health/gateway {
        proxy_pass http://gateway_service/health;
        access_log off;
    }
    
    # Panorama service health check  
    location /health/panorama {
        proxy_pass http://panorama_service/health;
        access_log off;
    }

    # ========================================
    # Security and Error Handling
    # ========================================
    
    # Security - hide server info
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block access to sensitive files
    location ~* \.(env|log|htaccess|htpasswd|ini|conf)$ {
        deny all;
        access_log off;
    }
    
    # Custom error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    # ========================================
    # Performance Monitoring
    # ========================================
    
    # Request timing headers (development)
    add_header X-Response-Time $request_time always;
    add_header X-Upstream-Time $upstream_response_time always;
}
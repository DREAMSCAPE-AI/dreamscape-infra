# DreamScape Business Pod Supervisor Configuration
# DR-327: INFRA-011 - Configuration Supervisor et Orchestration
# Manages NGINX, Voyage, AI, and Payment services in a single container

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info
silent=false
minfds=1024
minprocs=200

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
username=admin
password=dreamscape_supervisor_123

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
username=admin
password=dreamscape_supervisor_123

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Voyage Service Program - Priority 10 (starts first)
# ES Modules service - uses node directly (no tsconfig-paths needed)
[program:voyage-service]
command=node dist/server.js
directory=/app/voyage
user=nodejs
autostart=true
autorestart=true
priority=10
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/voyage-service.log
stderr_logfile=/var/log/supervisor/voyage-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV="%(ENV_NODE_ENV)s",PORT=3003,SERVICE_NAME="voyage-service",DATABASE_URL="%(ENV_DATABASE_URL)s",REDIS_URL="%(ENV_REDIS_URL)s"

# AI Service Program - Priority 20 (starts second) - STUB (Python)
[program:ai-service]
command=python3 server.py
directory=/app/ai
user=nodejs
autostart=true
autorestart=true
priority=20
startsecs=5
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/ai-service.log
stderr_logfile=/var/log/supervisor/ai-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=PORT=3004,SERVICE_NAME="ai-service"

# Payment Service Program - Priority 30 (starts third) - STUB
[program:payment-service]
command=node server.js
directory=/app/payment
user=nodejs
autostart=true
autorestart=true
priority=30
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=SIGTERM
stdout_logfile=/var/log/supervisor/payment-service.log
stderr_logfile=/var/log/supervisor/payment-service-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=NODE_ENV="%(ENV_NODE_ENV)s",PORT=3005,SERVICE_NAME="payment-service"

# NGINX Program - Priority 40 (starts after services)
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
priority=40
startsecs=5
startretries=3
stopwaitsecs=10
stopsignal=SIGQUIT
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
user=nginx

# Process monitoring group for coordinated restarts
[group:business-services]
programs=voyage-service,ai-service,payment-service
priority=100

[group:infrastructure]
programs=nginx
priority=200

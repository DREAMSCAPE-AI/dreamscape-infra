name: ğŸ§ª DreamScape Big Pods - Continuous Integration

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
    paths:
      - 'scripts/bigpods/**'
      - '.dreamscape.config.yml'
      - '.github/workflows/bigpods-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'scripts/bigpods/**'
      - '.dreamscape.config.yml'
      - '.github/workflows/bigpods-ci.yml'

# Concurrency to cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DREAMSCAPE_ENV: ci

jobs:
  # ============================================================================
  # Basic Validation: Only essential checks for infra repo
  # ============================================================================
  basic-validation:
    name: ğŸ” Basic Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Fix Script Permissions
        run: |
          echo "ğŸ”§ Setting script permissions..."
          find scripts/bigpods -name "*.sh" -type f -exec chmod +x {} \;

      - name: ğŸ§ª Validate Script Syntax
        run: |
          echo "ğŸ§ª Validating script syntax..."

          scripts=(
            "scripts/bigpods/build-bigpods.sh"
            "scripts/bigpods/dev-bigpods.sh"
            "scripts/bigpods/debug-bigpods.sh"
            "scripts/bigpods/deploy-bigpods.sh"
            "scripts/bigpods/backup-bigpods.sh"
            "scripts/bigpods/maintenance-bigpods.sh"
            "scripts/bigpods/logs-bigpods.sh"
            "scripts/bigpods/monitoring-bigpods.sh"
            "scripts/bigpods/scale-bigpods.sh"
            "scripts/bigpods/lib/common.sh"
          )

          for script in "${scripts[@]}"; do
            echo "ğŸ” Checking $script..."
            if bash -n "$script"; then
              echo "âœ… $script: syntax OK"
            else
              echo "âŒ $script: syntax error"
              exit 1
            fi
          done

      - name: ğŸ›¡ï¸ Check Script Permissions
        run: |
          echo "ğŸ›¡ï¸ Checking script permissions..."
          find scripts/bigpods -name "*.sh" -type f | while read script; do
            perms=$(stat -c "%a" "$script")
            if [[ "$perms" =~ ^[67][57][57]$ ]]; then
              echo "âœ… $script: $perms"
            else
              echo "âŒ $script: $perms (should be executable)"
              exit 1
            fi
          done

      - name: ğŸ“‹ Validate Configuration
        run: |
          echo "ğŸ“‹ Validating .dreamscape.config.yml..."
          if [[ -f ".dreamscape.config.yml" ]]; then
            python3 -c "import yaml; yaml.safe_load(open('.dreamscape.config.yml'))"
            echo "âœ… Configuration file is valid YAML"
          else
            echo "âŒ Configuration file not found"
            exit 1
          fi

      - name: ğŸ“Š Scripts Summary
        run: |
          echo "ğŸ“Š Big Pods Scripts Summary:"
          echo "============================"
          find scripts/bigpods -name "*.sh" -type f | sort | while read script; do
            size=$(wc -l < "$script")
            echo "ğŸ“„ $script ($size lines)"
          done
          echo ""
          echo "âœ… Validation completed successfully"
          echo "ğŸ“ Note: Comprehensive tests are in dreamscape-tests repository"
          echo "ğŸ”— Test branch: DR-331-bigpods-tests"

  # ============================================================================
  # Final Summary
  # ============================================================================
  validation-summary:
    name: ğŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [basic-validation]
    if: always()
    timeout-minutes: 2

    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "ğŸ“Š DreamScape Big Pods - Validation Summary"
          echo "==========================================="
          echo ""
          echo "ğŸ” Basic Validation: ${{ needs.basic-validation.result }}"
          echo ""

          if [[ "${{ needs.basic-validation.result }}" == "success" ]]; then
            echo "ğŸ‰ All validations passed!"
            echo "âœ… Scripts are ready for use"
            echo ""
            echo "ğŸ“ Repository: dreamscape-infra (scripts only)"
            echo "ğŸ§ª Tests: dreamscape-tests (DR-331-bigpods-tests branch)"
          else
            echo "âŒ Validation failed"
            echo "ğŸ” Please check script syntax and permissions"
            exit 1
          fi
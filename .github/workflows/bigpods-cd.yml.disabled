name: ğŸš€ DreamScape Big Pods - Continuous Deployment

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (optional)'
        required: false
        type: string
      deployment_strategy:
        description: 'Deployment Strategy'
        required: true
        default: 'rolling'
        type: choice
        options:
          - rolling
          - blue-green
          - canary
      force_deployment:
        description: 'Force deployment (skip validations)'
        required: false
        default: false
        type: boolean

# Prevent concurrent deployments
concurrency:
  group: deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  # Deployment Configuration
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  DEPLOYMENT_TIMEOUT: 1800

  # Registry Configuration
  REGISTRY_URL: ghcr.io
  REGISTRY_NAMESPACE: dreamscape

  # Monitoring Configuration
  MONITORING_ENABLED: true
  HEALTH_CHECK_TIMEOUT: 300

jobs:
  # ============================================================================
  # Pre-deployment: Validation and preparation
  # ============================================================================
  pre-deployment:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      deployment-version: ${{ steps.version.outputs.version }}
      target-environment: ${{ steps.environment.outputs.environment }}
      deployment-strategy: ${{ steps.strategy.outputs.strategy }}
      should-deploy: ${{ steps.validation.outputs.should-deploy }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¯ Determine Target Environment
        id: environment
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Determine Deployment Version
        id: version
        run: |
          if [[ "${{ inputs.version }}" != "" ]]; then
            version="${{ inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            version="${{ github.ref_name }}"
          else
            version="$(git rev-parse --short HEAD)"
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Deployment version: $version"

      - name: ğŸ¯ Determine Deployment Strategy
        id: strategy
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "strategy=${{ inputs.deployment_strategy }}" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.environment.outputs.environment }}" == "production" ]]; then
            echo "strategy=blue-green" >> $GITHUB_OUTPUT
          else
            echo "strategy=rolling" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Validate Deployment Prerequisites
        id: validation
        run: |
          echo "ğŸ” Validating deployment prerequisites..."

          target_env="${{ steps.environment.outputs.environment }}"
          version="${{ steps.version.outputs.version }}"

          # Check if this is a valid deployment
          should_deploy="true"

          # Production validations
          if [[ "$target_env" == "production" ]]; then
            # Must be a tag for production
            if [[ "${{ github.ref }}" != refs/tags/v* ]] && [[ "${{ inputs.force_deployment }}" != "true" ]]; then
              echo "âŒ Production deployments require version tags"
              should_deploy="false"
            fi

            # Version must follow semver
            if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] && [[ "${{ inputs.force_deployment }}" != "true" ]]; then
              echo "âŒ Production version must follow semantic versioning (v1.2.3)"
              should_deploy="false"
            fi
          fi

          echo "should-deploy=$should_deploy" >> $GITHUB_OUTPUT

          if [[ "$should_deploy" == "true" ]]; then
            echo "âœ… Prerequisites validated"
            echo "ğŸ¯ Environment: $target_env"
            echo "ğŸ“¦ Version: $version"
            echo "ğŸš€ Strategy: ${{ steps.strategy.outputs.strategy }}"
          else
            echo "âŒ Prerequisites validation failed"
            exit 1
          fi

  # ============================================================================
  # Build and Push: Build images and push to registry
  # ============================================================================
  build-and-push:
    name: ğŸ—ï¸ Build & Push Images
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.should-deploy == 'true'
    timeout-minutes: 30

    strategy:
      matrix:
        pod: [core, business, experience]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build ${{ matrix.pod }} Pod
        working-directory: scripts/bigpods
        timeout-minutes: 20
        run: |
          echo "ğŸ—ï¸ Building ${{ matrix.pod }} pod..."

          version="${{ needs.pre-deployment.outputs.deployment-version }}"

          # Build with version tag
          ./build-bigpods.sh \
            --pod ${{ matrix.pod }} \
            --version "$version" \
            --push \
            --verbose

      - name: ğŸ” Verify Image Push
        run: |
          echo "ğŸ” Verifying pushed image..."
          version="${{ needs.pre-deployment.outputs.deployment-version }}"
          image="${{ env.REGISTRY_URL }}/${{ env.REGISTRY_NAMESPACE }}/${{ matrix.pod }}-pod:$version"

          if docker manifest inspect "$image" >/dev/null 2>&1; then
            echo "âœ… Image successfully pushed: $image"
          else
            echo "âŒ Image verification failed: $image"
            exit 1
          fi

  # ============================================================================
  # Deploy to Staging: Always deploy to staging first
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment, build-and-push]
    if: needs.pre-deployment.outputs.should-deploy == 'true'
    timeout-minutes: 20
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Deployment Environment
        run: |
          echo "ğŸ”§ Setting up staging deployment environment..."

          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: ğŸš€ Deploy to Staging
        working-directory: scripts/bigpods
        timeout-minutes: 15
        run: |
          echo "ğŸš€ Deploying to staging environment..."

          version="${{ needs.pre-deployment.outputs.deployment-version }}"
          strategy="${{ needs.pre-deployment.outputs.deployment-strategy }}"

          # Configure staging deployment
          case "$strategy" in
            "rolling")
              deployment_args="--rolling"
              ;;
            "blue-green")
              deployment_args="--blue-green"
              ;;
            "canary")
              deployment_args="--canary --canary-percent 20"
              ;;
          esac

          # Execute deployment
          ./deploy-bigpods.sh \
            --env staging \
            --version "$version" \
            $deployment_args \
            --force \
            --verbose

      - name: ğŸ¥ Post-deployment Health Check
        working-directory: scripts/bigpods
        timeout-minutes: 5
        run: |
          echo "ğŸ¥ Running post-deployment health checks..."

          # Wait for services to be ready
          sleep 30

      - name: ğŸ§ª Run Smoke Tests
        working-directory: scripts/bigpods
        run: |
          echo "ğŸ§ª Running staging smoke tests..."

          # Basic connectivity tests
          ./debug-bigpods.sh --mode connectivity --env staging

          # API health tests
          echo "âœ… Smoke tests completed successfully"

  # ============================================================================
  # Deploy to Production: Only if targeting production
  # ============================================================================
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment, build-and-push, deploy-staging]
    if: |
      needs.pre-deployment.outputs.should-deploy == 'true' &&
      (needs.pre-deployment.outputs.target-environment == 'production' ||
       startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 30
    environment: production

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Production Environment
        run: |
          echo "ğŸ”§ Setting up production deployment environment..."

          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: ğŸ›¡ï¸ Pre-production Validation
        working-directory: scripts/bigpods
        run: |
          echo "ğŸ›¡ï¸ Running pre-production validation..."

          # Validate staging is healthy
          ./monitoring-bigpods.sh --mode health --env staging

          if [[ $? -ne 0 ]]; then
            echo "âŒ Staging is not healthy - aborting production deployment"
            exit 1
          fi

          echo "âœ… Staging validation passed"

      - name: ğŸ’¾ Backup Production
        working-directory: scripts/bigpods
        timeout-minutes: 10
        run: |
          echo "ğŸ’¾ Creating production backup before deployment..."

          ./backup-bigpods.sh \
            --type configs \
            --s3-bucket dreamscape-production-backups \
            --env production \
            --force

      - name: ğŸš€ Deploy to Production
        working-directory: scripts/bigpods
        timeout-minutes: 20
        run: |
          echo "ğŸš€ Deploying to production environment..."

          version="${{ needs.pre-deployment.outputs.deployment-version }}"
          strategy="${{ needs.pre-deployment.outputs.deployment-strategy }}"

          # Configure production deployment
          case "$strategy" in
            "rolling")
              deployment_args="--rolling"
              ;;
            "blue-green")
              deployment_args="--blue-green"
              ;;
            "canary")
              deployment_args="--canary --canary-percent 10"
              ;;
          esac

          # Execute deployment with notifications
          ./deploy-bigpods.sh \
            --env production \
            --version "$version" \
            $deployment_args \
            --notify \
            --slack-webhook "${{ secrets.SLACK_WEBHOOK_URL }}" \
            --force \
            --verbose

      - name: ğŸ“Š Post-deployment Monitoring
        working-directory: scripts/bigpods
        timeout-minutes: 5
        run: |
          echo "ğŸ“Š Setting up post-deployment monitoring..."

          # Start extended monitoring
          ./monitoring-bigpods.sh \
            --mode alerts \
            --env production \
            --cpu-threshold 80 \
            --memory-threshold 85 \
            --webhook "${{ secrets.SLACK_WEBHOOK_URL }}" &

  # ============================================================================
  # Post-deployment: Validation and monitoring
  # ============================================================================
  post-deployment:
    name: ğŸ“Š Post-deployment Validation
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-staging, deploy-production]
    if: always() && needs.pre-deployment.outputs.should-deploy == 'true'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ“Š DreamScape Big Pods Deployment Summary"
          echo "========================================"
          echo ""
          echo "ğŸ¯ Target Environment: ${{ needs.pre-deployment.outputs.target-environment }}"
          echo "ğŸ“¦ Version: ${{ needs.pre-deployment.outputs.deployment-version }}"
          echo "ğŸš€ Strategy: ${{ needs.pre-deployment.outputs.deployment-strategy }}"
          echo ""
          echo "ğŸ“‹ Deployment Results:"
          echo "ğŸš€ Staging: ${{ needs.deploy-staging.result }}"

          if [[ "${{ needs.deploy-production.result }}" != "" ]]; then
            echo "ğŸ­ Production: ${{ needs.deploy-production.result }}"
          fi

      - name: ğŸ“§ Send Deployment Notification
        if: always()
        run: |
          echo "ğŸ“§ Sending deployment notification..."

          if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            if [[ "${{ needs.deploy-production.result }}" == "success" ]] || [[ "${{ needs.deploy-production.result }}" == "" ]]; then
              echo "âœ… Deployment completed successfully!"
              status="success"
            else
              echo "âš ï¸ Production deployment failed, but staging succeeded"
              status="warning"
            fi
          else
            echo "âŒ Deployment failed"
            status="failure"
          fi

          # Store status for potential webhooks
          echo "DEPLOYMENT_STATUS=$status" >> $GITHUB_ENV

      - name: ğŸ§¹ Cleanup Old Images
        if: success()
        run: |
          echo "ğŸ§¹ Cleaning up old container images..."

          # Keep last 5 versions
          version="${{ needs.pre-deployment.outputs.deployment-version }}"

          # This would integrate with actual registry cleanup
          echo "ğŸ§¹ Cleanup would remove images older than 5 versions"
          echo "ğŸ“¦ Current version: $version"

  # ============================================================================
  # Rollback: Emergency rollback capability
  # ============================================================================
  emergency-rollback:
    name: ğŸ†˜ Emergency Rollback
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-production.result == 'failure')
    needs: [pre-deployment, deploy-production]
    timeout-minutes: 15
    environment: production

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ†˜ Execute Emergency Rollback
        working-directory: scripts/bigpods
        run: |
          echo "ğŸ†˜ Executing emergency rollback..."

          ./deploy-bigpods.sh \
            --env production \
            --rollback \
            --force \
            --notify \
            --slack-webhook "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: ğŸ¥ Verify Rollback Health
        working-directory: scripts/bigpods
        timeout-minutes: 5
        run: |
          echo "ğŸ¥ Verifying rollback health..."

          sleep 30
          ./monitoring-bigpods.sh --mode health --env production

          if [[ $? -eq 0 ]]; then
            echo "âœ… Rollback successful - system healthy"
          else
            echo "âŒ Rollback verification failed - manual intervention required"
            exit 1
          fi

# ============================================================================
# Workflow Status and Notifications
# ============================================================================
  workflow-status:
    name: ğŸ“¢ Workflow Status
    runs-on: ubuntu-latest
    needs: [post-deployment, emergency-rollback]
    if: always()

    steps:
      - name: ğŸ“¢ Final Status Report
        run: |
          echo "ğŸ“¢ DreamScape Big Pods CD - Final Status"
          echo "======================================"

          if [[ "${{ needs.post-deployment.result }}" == "success" ]]; then
            echo "ğŸ‰ Deployment workflow completed successfully!"
            echo "âœ… All services deployed and validated"
          elif [[ "${{ needs.emergency-rollback.result }}" == "success" ]]; then
            echo "ğŸ”„ Deployment failed but rollback successful"
            echo "âš ï¸ Please investigate deployment issues"
          else
            echo "âŒ Deployment workflow failed"
            echo "ğŸ†˜ Manual intervention may be required"
          fi
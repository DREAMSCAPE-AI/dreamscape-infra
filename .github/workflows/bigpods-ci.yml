name: ğŸ§ª DreamScape Big Pods - Continuous Integration

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
    paths:
      - 'scripts/bigpods/**'
      - '.dreamscape.config.yml'
      - 'docker/**'
      - '.github/workflows/bigpods-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'scripts/bigpods/**'
      - '.dreamscape.config.yml'
      - 'docker/**'
      - '.github/workflows/bigpods-ci.yml'

# Concurrency to cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Big Pods Configuration
  DREAMSCAPE_ENV: ci
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

  # Test Configuration
  CI_TEST_TIMEOUT: 1800
  CI_BUILD_TIMEOUT: 2400

jobs:
  # ============================================================================
  # Pre-checks: Validate scripts and configuration
  # ============================================================================
  pre-checks:
    name: ğŸ” Pre-checks & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      scripts-changed: ${{ steps.changes.outputs.scripts }}
      config-changed: ${{ steps.changes.outputs.config }}
      docker-changed: ${{ steps.changes.outputs.docker }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            scripts:
              - 'scripts/bigpods/**'
            config:
              - '.dreamscape.config.yml'
            docker:
              - 'docker/**'

      - name: ğŸ”§ Fix Script Permissions
        run: |
          echo "ğŸ”§ Setting script permissions..."
          find scripts/bigpods -name "*.sh" -type f -exec chmod +x {} \;

      - name: ğŸ›¡ï¸ Validate Scripts Permissions
        run: |
          echo "ğŸ” Checking script permissions..."
          find scripts/bigpods -name "*.sh" -type f | while read script; do
            perms=$(stat -c "%a" "$script")
            if [[ "$perms" =~ ^[67][57][57]$ ]]; then
              echo "âœ… $script: $perms"
            else
              echo "âŒ $script: $perms (insecure permissions)"
              exit 1
            fi
          done

      - name: ğŸ“‹ Validate Configuration
        run: |
          echo "ğŸ” Validating .dreamscape.config.yml..."
          if [[ -f ".dreamscape.config.yml" ]]; then
            # Basic YAML syntax check
            python3 -c "import yaml; yaml.safe_load(open('.dreamscape.config.yml'))"
            echo "âœ… Configuration file is valid YAML"
          else
            echo "âŒ Configuration file not found"
            exit 1
          fi

      - name: ğŸ” Security Scan - Secrets
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          secret_patterns=("password.*=" "secret.*=" "key.*=" "token.*=")
          issues=0

          for pattern in "${secret_patterns[@]}"; do
            if grep -r -i "$pattern" scripts/bigpods/ --exclude-dir=tests --exclude="*.md"; then
              echo "âš ï¸ Potential secret found: $pattern"
              issues=$((issues + 1))
            fi
          done

          if [[ $issues -gt 0 ]]; then
            echo "âŒ Security scan failed: $issues potential secrets found"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

      - name: ğŸ“Š Scripts Inventory
        run: |
          echo "ğŸ“Š Big Pods Scripts Inventory:"
          echo "================================"
          find scripts/bigpods -name "*.sh" -type f | sort | while read script; do
            size=$(wc -l < "$script")
            echo "ğŸ“„ $script ($size lines)"
          done

  # ============================================================================
  # Unit Tests: Test common library and script functions
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.scripts-changed == 'true'
    timeout-minutes: 15

    strategy:
      matrix:
        test-suite:
          - common
          - scripts

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§ Setup Test Environment
        run: |
          echo "ğŸ› ï¸ Setting up test environment..."
          sudo apt-get update -qq
          sudo apt-get install -y bc jq curl

      - name: ğŸ§ª Run ${{ matrix.test-suite }} Tests
        working-directory: scripts/bigpods
        run: |
          echo "ğŸ§ª Running ${{ matrix.test-suite }} tests..."

          case "${{ matrix.test-suite }}" in
            "common")
              ./tests/test_common.sh --verbose
              ;;
            "scripts")
              ./tests/test_scripts.sh --verbose --skip-docker
              ;;
          esac

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            /tmp/dreamscape_tests/
            scripts/bigpods/tests/*.log
          retention-days: 7

  # ============================================================================
  # Integration Tests: Test with Docker and real containers
  # ============================================================================
  integration-tests:
    name: ğŸ”§ Integration Tests
    runs-on: ubuntu-latest
    needs: [pre-checks, unit-tests]
    if: needs.pre-checks.outputs.scripts-changed == 'true' || needs.pre-checks.outputs.docker-changed == 'true'
    timeout-minutes: 30

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker
        run: |
          echo "ğŸ³ Setting up Docker environment..."
          docker --version
          docker-compose --version || docker compose version

      - name: ğŸ› ï¸ Setup Test Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bc jq curl apache2-utils

      - name: ğŸ§ª Run Integration Tests
        working-directory: scripts/bigpods
        timeout-minutes: 25
        run: |
          echo "ğŸ§ª Running integration tests with Docker..."
          ./tests/run_all_tests.sh --verbose --parallel

      - name: ğŸ” Docker Images Inventory
        if: always()
        run: |
          echo "ğŸ” Docker images after tests:"
          docker images

      - name: ğŸ“Š Upload Integration Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            /tmp/dreamscape_tests/
          retention-days: 7

  # ============================================================================
  # Build Tests: Test Big Pods build process
  # ============================================================================
  build-tests:
    name: ğŸ—ï¸ Build Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.scripts-changed == 'true' || needs.pre-checks.outputs.docker-changed == 'true'
    timeout-minutes: 20

    strategy:
      matrix:
        pod: [core, business, experience]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Test Build ${{ matrix.pod }} Pod
        working-directory: scripts/bigpods
        timeout-minutes: 15
        run: |
          echo "ğŸ—ï¸ Testing build for ${{ matrix.pod }} pod..."

          # Test build script help and validation
          ./build-bigpods.sh --help

          # Test dry-run build
          ./build-bigpods.sh --pod ${{ matrix.pod }} --smart --dry-run --verbose

      - name: ğŸ“Š Build Cache Info
        run: |
          echo "ğŸ“Š Docker build cache:"
          docker system df

  # ============================================================================
  # Security Tests: Security scanning and validation
  # ============================================================================
  security-tests:
    name: ğŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Shell Script Security Scan
        run: |
          echo "ğŸ” Running ShellCheck security analysis..."

          # Install ShellCheck
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck

          # Run ShellCheck on all scripts
          find scripts/bigpods -name "*.sh" -type f | while read script; do
            echo "ğŸ” Analyzing $script..."
            if shellcheck -S warning "$script"; then
              echo "âœ… $script passed security analysis"
            else
              echo "âŒ $script failed security analysis"
              exit 1
            fi
          done

      - name: ğŸ›¡ï¸ Container Security Scan
        if: needs.pre-checks.outputs.docker-changed == 'true'
        run: |
          echo "ğŸ›¡ï¸ Scanning Docker configurations for security issues..."

          # Check for privileged containers
          if grep -r "privileged.*true" docker/; then
            echo "âš ï¸ Privileged containers detected"
          fi

          # Check for host network mode
          if grep -r "network_mode.*host" docker/; then
            echo "âš ï¸ Host network mode detected"
          fi

          echo "âœ… Container security scan completed"

      - name: ğŸ“‹ Dependency Vulnerability Check
        run: |
          echo "ğŸ“‹ Checking for vulnerable dependencies..."

          # Basic check for outdated base images
          if grep -r "FROM.*:latest" docker/; then
            echo "âš ï¸ Latest tags detected - consider pinning versions"
          fi

          echo "âœ… Dependency check completed"

  # ============================================================================
  # Performance Tests: Validate script performance
  # ============================================================================
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: needs.pre-checks.outputs.scripts-changed == 'true'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Script Performance Tests
        working-directory: scripts/bigpods
        run: |
          echo "âš¡ Testing script startup performance..."

          scripts=(
            "build-bigpods.sh"
            "dev-bigpods.sh"
            "debug-bigpods.sh"
            "deploy-bigpods.sh"
            "logs-bigpods.sh"
            "monitoring-bigpods.sh"
            "scale-bigpods.sh"
          )

          total_time=0
          for script in "${scripts[@]}"; do
            echo "â±ï¸ Testing $script startup time..."
            start_time=$(date +%s%3N)

            timeout 30s ./"$script" --help >/dev/null 2>&1

            end_time=$(date +%s%3N)
            duration=$((end_time - start_time))
            total_time=$((total_time + duration))

            echo "âœ… $script: ${duration}ms"

            # Fail if any script takes more than 5 seconds
            if [[ $duration -gt 5000 ]]; then
              echo "âŒ $script startup too slow: ${duration}ms"
              exit 1
            fi
          done

          avg_time=$((total_time / ${#scripts[@]}))
          echo "ğŸ“Š Average startup time: ${avg_time}ms"

          if [[ $avg_time -lt 1000 ]]; then
            echo "ğŸ‰ Excellent performance: ${avg_time}ms average"
          elif [[ $avg_time -lt 2000 ]]; then
            echo "âœ… Good performance: ${avg_time}ms average"
          else
            echo "âš ï¸ Performance could be improved: ${avg_time}ms average"
          fi

  # ============================================================================
  # Documentation Tests: Validate documentation
  # ============================================================================
  documentation-tests:
    name: ğŸ“š Documentation Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“š Validate Documentation
        run: |
          echo "ğŸ“š Validating documentation..."

          required_docs=(
            "scripts/bigpods/docs/README.md"
            "scripts/bigpods/docs/GETTING_STARTED.md"
            "scripts/bigpods/docs/EXAMPLES.md"
          )

          for doc in "${required_docs[@]}"; do
            if [[ -f "$doc" ]]; then
              echo "âœ… $doc exists"

              # Basic content validation
              if [[ $(wc -l < "$doc") -gt 50 ]]; then
                echo "âœ… $doc has substantial content"
              else
                echo "âš ï¸ $doc seems too short"
              fi
            else
              echo "âŒ $doc missing"
              exit 1
            fi
          done

      - name: ğŸ“– Check Help Documentation
        working-directory: scripts/bigpods
        run: |
          echo "ğŸ“– Validating script help documentation..."

          scripts=(build-bigpods.sh dev-bigpods.sh debug-bigpods.sh)

          for script in "${scripts[@]}"; do
            echo "ğŸ“– Testing $script help..."
            help_output=$(./"$script" --help)

            # Check for required sections
            if echo "$help_output" | grep -q "USAGE"; then
              echo "âœ… $script has USAGE section"
            else
              echo "âŒ $script missing USAGE section"
              exit 1
            fi

            if echo "$help_output" | grep -q "EXAMPLES"; then
              echo "âœ… $script has EXAMPLES section"
            else
              echo "âŒ $script missing EXAMPLES section"
              exit 1
            fi
          done

  # ============================================================================
  # Final Summary: Aggregate all test results
  # ============================================================================
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [pre-checks, unit-tests, integration-tests, build-tests, security-tests, performance-tests, documentation-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Generate Test Summary
        run: |
          echo "ğŸ“Š DreamScape Big Pods CI - Test Summary"
          echo "======================================="
          echo ""

          # Check results
          echo "ğŸ” Pre-checks: ${{ needs.pre-checks.result }}"
          echo "ğŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
          echo "ğŸ”§ Integration Tests: ${{ needs.integration-tests.result }}"
          echo "ğŸ—ï¸ Build Tests: ${{ needs.build-tests.result }}"
          echo "ğŸ”’ Security Tests: ${{ needs.security-tests.result }}"
          echo "âš¡ Performance Tests: ${{ needs.performance-tests.result }}"
          echo "ğŸ“š Documentation Tests: ${{ needs.documentation-tests.result }}"
          echo ""

          # Determine overall result
          failed_jobs=0

          [[ "${{ needs.pre-checks.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.unit-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.integration-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.build-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.security-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.performance-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))
          [[ "${{ needs.documentation-tests.result }}" == "failure" ]] && failed_jobs=$((failed_jobs + 1))

          if [[ $failed_jobs -eq 0 ]]; then
            echo "ğŸ‰ All tests passed! Big Pods suite is ready for deployment."
            echo "âœ… Quality gate: PASSED"
          else
            echo "âŒ $failed_jobs test suite(s) failed."
            echo "âŒ Quality gate: FAILED"
            exit 1
          fi

      - name: ğŸ“¤ Upload CI Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-summary-${{ github.run_number }}
          path: |
            /tmp/ci-summary.txt
          retention-days: 30

# ============================================================================
# Notification and Status Updates
# ============================================================================
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¢ Notify Success
        if: needs.test-summary.result == 'success'
        run: |
          echo "ğŸ‰ DreamScape Big Pods CI completed successfully!"
          echo "âœ… All quality gates passed"
          echo "ğŸš€ Ready for deployment"

      - name: ğŸ“¢ Notify Failure
        if: needs.test-summary.result == 'failure'
        run: |
          echo "âŒ DreamScape Big Pods CI failed"
          echo "ğŸ” Please review test results and fix issues"
          echo "ğŸ“‹ Check the Actions tab for detailed logs"
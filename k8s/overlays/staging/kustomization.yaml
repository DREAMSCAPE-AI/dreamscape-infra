apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: dreamscape-staging

namespace: dreamscape-staging

resources:
- ../../base/auth
- ../../base/gateway
- ../../base/user
- ../../base/voyage
- ../../base/common

patchesStrategicMerge:
- auth-patch.yaml
- gateway-patch.yaml
- user-patch.yaml
- voyage-patch.yaml

configMapGenerator:
- name: environment-config
  literals:
  - ENVIRONMENT=staging
  - LOG_LEVEL=info
  - ENABLE_METRICS=true
  - ENABLE_TRACING=true

images:
- name: ghcr.io/dreamscape/auth
  newTag: main
- name: ghcr.io/dreamscape/gateway
  newTag: main
- name: ghcr.io/dreamscape/user
  newTag: main
- name: ghcr.io/dreamscape/voyage
  newTag: main

replicas:
- name: auth-service
  count: 2
- name: gateway-service
  count: 2
- name: user-service
  count: 2
- name: voyage-service
  count: 2

labels:
- pairs:
    environment: staging
    version: main

patches:
- target:
    kind: Ingress
    name: gateway-ingress
  patch: |-
    - op: replace
      path: /spec/rules/0/host
      value: staging-api.dreamscape.com
    - op: replace
      path: /spec/tls/0/hosts/0
      value: staging-api.dreamscape.com

- target:
    kind: HorizontalPodAutoscaler
  patch: |-
    - op: replace
      path: /spec/maxReplicas
      value: 5